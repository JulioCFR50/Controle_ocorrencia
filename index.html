<!DOCTYPE html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <meta name="description" content="Pagina Cadastro Mercado Externo>
      <meta name="author" content="Julio Cesar">
      <title>Controle Mercado Externo</title>
      <style>
         * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         }
         /* ===== BODY E CONTAINER ===== */
         html, body {
         height: 100%;
         font-family: Arial, sans-serif;
         background: url("coqueiral.png") no-repeat center center fixed;
         background-size: cover;
         }
         .container {
         display: flex;
         flex-direction: column;
         width: 100%;
         min-height: 100vh;
         padding: 15px;
         background: rgba(255, 255, 255, 0.45);
         backdrop-filter: blur(10px);
         border-radius: 8px;
         box-shadow: 0 8px 15px rgba(0,0,0,0.3);
         font-size: 0.8rem;
         overflow: hidden;
         }
         /* ===== TITULO H1 ===== */
         .container h1 {
         font-size: 1.2rem;
         text-align: center;
         color: #333;
         position: sticky;
         top: 0;
         background: rgba(255, 255, 255, 0.6);
         backdrop-filter: blur(10px);
         z-index: 4;
         padding: 8px 0;
         margin-bottom: 5px;
         }
         /* ===== CAMPOS DE PESQUISA E BOT√ïES ===== */
         .pesquisa-container {
         display: flex;
         flex-wrap: wrap;
         gap: 6px;
         margin-bottom: 10px;
         }
         .pesquisa-container input,
         .pesquisa-container button {
         font-size: 0.75rem;
         padding: 3px 5px;
         border-radius: 4px;
         border: 1px solid #ccc;
         text-align: center;
         }
         .pesquisa-container input { flex: 1 1 100px; min-width: 90px; }
         .pesquisa-container button { cursor: pointer; flex: 1 1 90px; }
         .pesquisa-container button.salvar { background: #28a745; color: white; border: none; }
         .pesquisa-container button.limpar { background: #f0f0f0; color: #333; border: none; }
         .pesquisa-container button.excluir { background: #dc3545; color: white; border: none; }
         .pesquisa-container button.btn-lista { background: #007bff; color: white; border: none; }
         #filtroInvoice {
         width: 100%;
         max-width: 150px;
         padding: 6px;
         margin-bottom: 8px;
         font-size: 0.85rem;
         border-radius: 4px;
         border: 1px solid #ccc;
         }
         /* ===== FORMULARIO ===== */
         form {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
         gap: 10px;
         margin-bottom: 10px;
         }
         form div { display: flex; flex-direction: column; }
         form div label { font-size: 0.75rem; }
         input, select {
         width: 100%;
         font-size: 0.75rem;
         padding: 4px;
         border: 1px solid #ccc;
         border-radius: 4px;
         }
         input:focus, select:focus {
         border-color: #fd4213;
         box-shadow: 0 0 6px rgba(250, 30, 1, 0.7);
         outline: none;
         }
         /* ===== BOTOES DO FORM ===== */
         .buttons {
         display: flex;
         justify-content: space-between;
         margin-top: 8px;
         gap: 6px;
         }
         .buttons button {
         flex: 1;
         font-size: 0.75rem;
         padding: 5px;
         border-radius: 6px;
         cursor: pointer;
         }
         /* ===== LISTA DE INVOICES ===== */
         #listaInvoices {
         flex: 1;
         overflow: auto;
         border: 1px solid #ccc;
         border-radius: 6px;
         background: rgba(255, 255, 255, 0.40);
         }
         #listaInvoices table {
         width: 100%;
         border-collapse: collapse;
         min-width: 700px; /* tabela m√≠nima para telas pequenas */
         }
         #listaInvoices th, #listaInvoices td {
         border: 1px solid #ccc;
         font-size: 0.75rem;
         padding: 2px;
         text-align: center;
         background: rgba(255,255,255,0.95);
         font-weight: normal;
         white-space: nowrap;
         overflow: hidden;
         text-overflow: ellipsis;
         }
         /* CABE√áALHO FIXO */
         #listaInvoices th {
         background: rgba(0, 123, 255, 0.85);
         color: white;
         font-weight: bold;
         position: sticky;
         top: 42px;
         z-index: 3;
         backdrop-filter: blur(6px);
         }
         /* ZEBRA */
         #listaInvoices tr:nth-child(even) td { background: rgba(240, 240, 240, 0.8); }
         #listaInvoices tr:nth-child(odd) td { background: rgba(255, 255, 255, 0.55); }
         /* HOVER */
         #listaInvoices tr:hover td { background: #fdf59f !important; cursor: pointer; }
         /* OBSERVA√á√ïES */
       #observacoes {
        width: 100%;
        font-size: 0.75rem;
        padding: 4px 210px;       /* padding pequeno e uniforme */
        box-sizing: border-box;
        text-align: left;       /* texto sempre come√ßa na esquerda */
        white-space: normal;    /* comportamento padr√£o */
        overflow: visible;      /* n√£o corta o texto */
      }

         /* ===== RESPONSIVIDADE TOTAL ===== */
         @media (max-width: 1200px) {
         form { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
         .pesquisa-container input, .pesquisa-container button { font-size: 0.7rem; padding: 3px; }
         }
         @media (max-width: 992px) {
         form { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
         .pesquisa-container { flex-direction: column; }
         .pesquisa-container input, .pesquisa-container button { flex: 1 1 100%; }
         #listaInvoices table { min-width: 600px; }
         }
         @media (max-width: 768px) {
         form { grid-template-columns: 1fr; }
         .buttons { flex-direction: column; }
         #listaInvoices table { min-width: 500px; }
         }
         @media (max-width: 576px) {
         .container { padding: 10px; font-size: 0.7rem; }
         input, select, .pesquisa-container input, .pesquisa-container button { font-size: 0.65rem; padding: 2px; }
         #listaInvoices th, #listaInvoices td { font-size: 0.65rem; padding: 1px; }
         #listaInvoices table { min-width: 400px; }
         }
         /* ===== FOOTER ===== */
         footer {
         margin-top: 4px;  
         display: flex; 
         justify-content: space-between; 
         font-size: 0.65rem; 
         color: #f8f6f6;
         border-top: 1px solid #ccc;
         }
         /* Linha clicada (ativa) 
         #listaInvoices tr.ativo td {
         background: orange !important;
         font-weight: bold;
         }*/
      </style>
   </head>
   <body>
      <div class="container">
         <h1>Controle Mercado Externo</h1>
         <div class="pesquisa-container">
            <input type="text" id="pesquisaInvoice" placeholder="Invoice">
            <input type="text" id="pesquisaDtFat" placeholder="DT Faturamento">
            <input type="text" id="pesquisaDtCar" placeholder="DT Carregamento">
            <input type="text" id="pesquisaDraft" placeholder="Dead-Line Draft">
            <input type="text" id="pesquisaVgm" placeholder="Dead-line VGM">
            <input type="text" id="pesquisaCarga" placeholder="Dead-line Carga">            
            <button class="salvar" id="btnSalvar">Salvar / Atualizar</button>
            <button class="limpar" id="btnLimpar">Limpar</button>
            <button class="excluir" id="btnExcluir">Excluir</button>
            <button class="btn-lista" id="btnConsultar">Consultar Invoice</button>
            <button class="btn-lista" id="btnBuscarLista">Pesquisar e Editar</button>        
         </div>
         <input type="text" id="filtroInvoice" placeholder="Pesquisar INVOICES ">
         <form id="formInvoice">
            <div><label for="invoice">INVOICE</label><input type="text" id="invoice"></div>
            <div><label for="dtFaturamento">DT Faturamento</label><input type="text" id="dtFaturamento"></div>
            <div><label for="dtCarregamento">DT Carregamento</label><input type="text" id="dtCarregamento"></div>
            <div><label for="draft">Dead-Line Draft</label><input type="text" id="draft"></div>
            <div><label for="vgm">Dead-line VGM</label><input type="text" id="vgm"></div>
            <div><label for="carga">Dead-line Carga</label><input type="text" id="carga"></div>
            <div><label for="embarque">DT Embarque</label><input type="text" id="embarque"></div>
            <div>
               <label for="status">Status Faturamento</label>
               <select id="status">
                  <option value=""></option>
                  <option>Pendente</option>
                  <option>Conclu√≠do</option>
               </select>
            </div>
            <div>
               <label for="booking">Status Booking</label>
               <select id="booking">
                  <option value=""></option>
                  <option>Aguardando</option>
                  <option>Confirmado</option>
               </select>
            </div>
            <div>
               <label for="instrucao">Instru√ß√£o de Embarque</label>
               <select id="instrucao">
                  <option value=""></option>
                  <option>Pendente</option>
                  <option>Enviada</option>
               </select>
            </div>
            <div>
               <label for="producao">Status Produ√ß√£o</label>
               <select id="producao">
                  <option value=""></option>
                  <option>Pendente</option>
                  <option>Confirmado</option>
               </select>
            </div>
            <div><label for="dtProduto">Prontid√£o do Pedido</label><input type="text" id="dtProduto"></div>
            <div><label for="observacoes">Observa√ß√µes</label><input type="text" id="observacoes"></div>
         </form>
         <div id="listaInvoices">
            <h1>Lista de Invoices</h1>
            <table>
               <thead>
                  <tr>
                     <th>Invoice</th>
                     <th>DT Faturamento</th>
                     <th>DT Carregamento</th>
                     <th>Dead-Line Draft</th>
                     <th>Dead-line VGM</th>
                     <th>Dead-line Carga</th>
                     <th>DT Embarque</th>
                     <th>Status Faturamento</th>
                     <th>Status Booking</th>
                     <th>Instru√ß√£o de Embarque</th>
                     <th>Status Produ√ß√£o</th>
                     <th>Prontid√£o do Pedido<button id="btnOrdenarDtProduto" style="background:none;border:none;color:white;cursor:pointer;">üîÑ</button></th>
                     <th>Observa√ß√µes</th>
                     <th>A√ß√£o</th>
                  </tr>
               </thead>
               <tbody id="tabelaInvoices"></tbody>
            </table>
         </div>
         <!-- FOOTER -->
         <footer>
            <span>¬© 2025 Julio Cesar. Todos os direitos reservados.</span>
         </footer>
      </div>
      <!-- Firebase + App JS -->
      <script type="module">
         import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
         import { 
            getFirestore, collection, getDocs, getDoc, setDoc, doc, deleteDoc 
         } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
         
         // === Firebase config (a sua) ===
         const firebaseConfig = {
            apiKey: "AIzaSyACGNNnZcHU1yA3Vozek5cD6egRnADDKUI",
            authDomain: "controle-mercado-externo-9c3e8.firebaseapp.com",
            projectId: "controle-mercado-externo-9c3e8",
            storageBucket: "controle-mercado-externo-9c3e8.appspot.com",
            messagingSenderId: "523084089883",
            appId: "1:523084089883:web:6b9750c6df679852b346be",
            measurementId: "G-RCJG4ZWJ9E"
          };
         
         const app = initializeApp(firebaseConfig);
         const db  = getFirestore(app);
         const invoicesCol = collection(db, "invoices");
         
         // ======= Estado em mem√≥ria (equivale ao antigo localStorage na tela) =======
         let cacheInvoices = [];         // lista carregada do Firestore
         let ordemDtProdutoCrescente = true;
         
         // ======= Util: renderiza√ß√£o da tabela a partir de uma lista =======
         function renderTabela(lista) {
            const tbody = document.getElementById("tabelaInvoices");
            tbody.innerHTML = "";
            lista.forEach(r => {
               const tr = document.createElement("tr");
               tr.innerHTML = `
                  <td>${r.invoice || ""}</td>
                  <td>${r.dtFaturamento || ""}</td>
                  <td>${r.dtCarregamento || ""}</td>
                  <td>${r.draft || ""}</td>
                  <td>${r.vgm || ""}</td>
                  <td>${r.carga || ""}</td>
                  <td>${r.embarque || ""}</td>
                  <td>${r.status || ""}</td>
                  <td>${r.booking || ""}</td>
                  <td>${r.instrucao || ""}</td>
                  <td>${r.producao || ""}</td>
                  <td>${r.dtProduto || ""}</td>
                  <td>${r.observacoes || ""}</td>
                  <td><button onclick="editarInvoice('${(r.invoice || "").replace(/'/g, "\\'")}')">‚úèÔ∏è Editar</button></td>
               `;
               tbody.appendChild(tr);
            });
         }
         
         // ======= Aplicar filtros dos campos superiores sobre a cache =======
         function listaFiltrada() {
            const fInvoice = (document.getElementById("pesquisaInvoice").value || "").toLowerCase();
            const fDtFat   = (document.getElementById("pesquisaDtFat").value   || "").toLowerCase();
            const fDtCar   = (document.getElementById("pesquisaDtCar").value   || "").toLowerCase();
            const fDraft   = (document.getElementById("pesquisaDraft").value   || "").toLowerCase();
            const fVgm     = (document.getElementById("pesquisaVgm").value     || "").toLowerCase();
            const fCarga   = (document.getElementById("pesquisaCarga").value   || "").toLowerCase();
         
            return cacheInvoices.filter(r =>
               (r.invoice || "").toLowerCase().includes(fInvoice) &&
               (r.dtFaturamento || "").toLowerCase().includes(fDtFat) &&
               (r.dtCarregamento || "").toLowerCase().includes(fDtCar) &&
               (r.draft || "").toLowerCase().includes(fDraft) &&
               (r.vgm || "").toLowerCase().includes(fVgm) &&
               (r.carga || "").toLowerCase().includes(fCarga)
            );
         }
         
         // ======= Carregar do Firestore para a cache e renderizar =======
         async function atualizarLista() {
            const snap = await getDocs(collection(db, "invoices"));
            cacheInvoices = [];
            snap.forEach(docSnap => {
               cacheInvoices.push(docSnap.data());
            });
            renderTabela(listaFiltrada());
         }
         
         // ======= Formata√ß√£o/valida√ß√£o de data/hora (SEU C√ìDIGO, mantido) =======
         function formatarDataHora(input) {
             let valor = input.value.replace(/\D/g, '');
             if (valor.length <= 8) { 
                 if (valor.length > 2 && valor.length <= 4) valor = valor.slice(0,2) + '/' + valor.slice(2);
                 else if (valor.length > 4) valor = valor.slice(0,2) + '/' + valor.slice(2,4) + '/' + valor.slice(4,8);
             } else { 
                 const data = valor.slice(0,8);
                 const hora = valor.slice(8,12);
                 valor = data.slice(0,2)+'/'+data.slice(2,4)+'/'+data.slice(4,8);
                 if (hora.length > 0) valor += ' √†s ' + hora.slice(0,2) + ':' + hora.slice(2,4);
             }
             input.value = valor;
         }
         function validarDataHora(valor) {
             const partes = valor.split(' √†s ');
             const data = partes[0].split('/');
             const hora = partes[1] ? partes[1].split(':') : ['00','00'];
             const dia = parseInt(data[0], 10);
             const mes = parseInt(data[1], 10) - 1;
             const ano = parseInt(data[2], 10);
             const h = parseInt(hora[0], 10);
             const m = parseInt(hora[1], 10);
             const d = new Date(ano, mes, dia, h, m);
             if (d.getFullYear() !== ano || d.getMonth() !== mes || d.getDate() !== dia ||
                 d.getHours() !== h || d.getMinutes() !== m) {
                 return false;
             }
             return true;
         }
         
         // ======= Eventos (mantidos/adaptados) =======
         // Filtros instant√¢neos
         ["pesquisaInvoice","pesquisaDtFat","pesquisaDtCar","pesquisaDraft","pesquisaVgm","pesquisaCarga"]
            .forEach(id => {
               document.getElementById(id).addEventListener("input", () => {
                  renderTabela(listaFiltrada());
               });
            });
         
         // Formata√ß√£o autom√°tica para datas/hora
         ['draft','vgm','carga','dtFaturamento','dtCarregamento','embarque','dtProduto'].forEach(id => {
              const el = document.getElementById(id);
              el.addEventListener('input', () => formatarDataHora(el));
              el.addEventListener('blur', () => {
                  if (el.value.trim() === "") return; // permite vazio
                  if (!validarDataHora(el.value)) {
                      alert("Data errada");
                      el.focus();
                  }
              });
          });
         
         
         // Salvar / Atualizar
         document.getElementById("btnSalvar").addEventListener("click", async () => {
            const invoice = document.getElementById("invoice").value.trim();
            if (!invoice) return alert("Preencha o n√∫mero da INVOICE.");
         
            const obj = {
               invoice,
               dtFaturamento: document.getElementById("dtFaturamento").value || "",
               dtCarregamento: document.getElementById("dtCarregamento").value || "",
               draft: document.getElementById("draft").value || "",
               vgm: document.getElementById("vgm").value || "",
               carga: document.getElementById("carga").value || "",
               embarque: document.getElementById("embarque").value || "",
               status: document.getElementById("status").value || "",
               booking: document.getElementById("booking").value || "",
               instrucao: document.getElementById("instrucao").value || "",
               producao: document.getElementById("producao").value || "",
               dtProduto: document.getElementById("dtProduto").value || "",
               observacoes: document.getElementById("observacoes").value || "",
            };
         
            try {
               await setDoc(doc(db, "invoices", invoice), obj); // upsert pelo ID = invoice
               alert("Invoice salva com sucesso!");
               document.getElementById("formInvoice").reset();
               ["pesquisaInvoice","pesquisaDtFat","pesquisaDtCar","pesquisaDraft","pesquisaVgm","pesquisaCarga","filtroInvoice"]
                  .forEach(id => document.getElementById(id).value = "");
               await atualizarLista();
            } catch (e) {
               console.error(e);
               alert("Erro ao salvar no Firestore.");
            }
         });
         
         // Limpar
         document.getElementById("btnLimpar").addEventListener("click", () => {
            document.getElementById("formInvoice").reset();
            ["pesquisaInvoice","pesquisaDtFat","pesquisaDtCar","pesquisaDraft","pesquisaVgm","pesquisaCarga","filtroInvoice"]
               .forEach(id => document.getElementById(id).value = "");
            renderTabela(listaFiltrada());
         });
         
         // Excluir
         document.getElementById("btnExcluir").addEventListener("click", async () => {
            const invoice = document.getElementById("invoice").value.trim();
            if (!invoice) return alert("Digite a INVOICE para excluir.");
            if (!confirm("Deseja realmente excluir a INVOICE: " + invoice + "?")) return;
            try {
               await deleteDoc(doc(db, "invoices", invoice));
               document.getElementById("formInvoice").reset();
               ["pesquisaInvoice","pesquisaDtFat","pesquisaDtCar","pesquisaDraft","pesquisaVgm","pesquisaCarga","filtroInvoice"]
                  .forEach(id => document.getElementById(id).value = "");
               await atualizarLista();
            } catch (e) {
               console.error(e);
               alert("Erro ao excluir no Firestore.");
            }
         });
         
         // Consultar Invoice ‚Üí redireciona para lista.html (mantido)
         document.getElementById("btnConsultar").addEventListener("click", () => {
             window.location.href = "lista.html";
         });
         
         // Buscar e editar
         document.getElementById("btnBuscarLista").addEventListener("click", async () => {
            const filtro = (document.getElementById("filtroInvoice").value || "").trim().toLowerCase();
            if (!filtro) return alert("Digite a invoice que deseja buscar.");
         
            // procura na cache (case-insensitive)
            let registro = cacheInvoices.find(r => (r.invoice || "").toLowerCase() === filtro);
         
            // se n√£o achar, tenta buscar direto pelo ID informado (case exato)
            if (!registro) {
               const tryDoc = await getDoc(doc(db, "invoices", document.getElementById("filtroInvoice").value.trim()));
               if (tryDoc.exists()) registro = tryDoc.data();
            }
         
            if (!registro) return alert("Invoice n√£o encontrada na lista.");
         
            // Preenche o form
            document.getElementById("invoice").value = registro.invoice || "";
            document.getElementById("dtFaturamento").value = registro.dtFaturamento || "";
            document.getElementById("dtCarregamento").value = registro.dtCarregamento || "";
            document.getElementById("draft").value = registro.draft || "";
            document.getElementById("vgm").value = registro.vgm || "";
            document.getElementById("carga").value = registro.carga || "";
            document.getElementById("embarque").value = registro.embarque || "";
            document.getElementById("status").value = registro.status || "";
            document.getElementById("booking").value = registro.booking || "";
            document.getElementById("instrucao").value = registro.instrucao || "";
            document.getElementById("producao").value = registro.producao || "";
            document.getElementById("dtProduto").value = registro.dtProduto || "";
            document.getElementById("observacoes").value = registro.observacoes || "";
         
            // Mostra somente ela na tabela
            renderTabela([registro]);
         });
         
         // Ordenar por dtProduto (sem gravar no banco)
         function parseDDMMYYYY(d) {
            if (!d) return 0;
            const partesHora = d.split(" √†s ");
            const [dd, mm, yyyy] = (partesHora[0] || "").split("/");
            if (!dd || !mm || !yyyy) return 0;
            const dt = new Date(parseInt(yyyy,10), parseInt(mm,10)-1, parseInt(dd,10)).getTime();
            return isNaN(dt) ? 0 : dt;
         }
         document.getElementById("btnOrdenarDtProduto").addEventListener("click", () => {
            const lista = [...listaFiltrada()];
            lista.sort((a,b) => {
               const A = parseDDMMYYYY(a.dtProduto);
               const B = parseDDMMYYYY(b.dtProduto);
               return ordemDtProdutoCrescente ? (A - B) : (B - A);
            });
            ordemDtProdutoCrescente = !ordemDtProdutoCrescente;
            renderTabela(lista);
         });
         
         // Destaque ao clicar na linha (mantido)
         document.addEventListener("click", function(e) {
           const linha = e.target.closest("#listaInvoices tbody tr");
           if (!linha) return;
           document.querySelectorAll("#listaInvoices tbody tr").forEach(tr => tr.classList.remove("ativo"));
           linha.classList.add("ativo");
         });
         
         // ======= Expor fun√ß√µes usadas em onclick no HTML gerado =======
         window.editarInvoice = async function(invoiceBusca) {
            // tenta na cache
            let registro = cacheInvoices.find(r => r.invoice === invoiceBusca);
            if (!registro) {
               const ds = await getDoc(doc(db, "invoices", invoiceBusca));
               if (ds.exists()) registro = ds.data();
            }
            if (!registro) return alert("Invoice n√£o encontrada.");
         
            document.getElementById("invoice").value = registro.invoice || "";
            document.getElementById("dtFaturamento").value = registro.dtFaturamento || "";
            document.getElementById("dtCarregamento").value = registro.dtCarregamento || "";
            document.getElementById("draft").value = registro.draft || "";
            document.getElementById("vgm").value = registro.vgm || "";
            document.getElementById("carga").value = registro.carga || "";
            document.getElementById("embarque").value = registro.embarque || "";
            document.getElementById("status").value = registro.status || "";
            document.getElementById("booking").value = registro.booking || "";
            document.getElementById("instrucao").value = registro.instrucao || "";
            document.getElementById("producao").value = registro.producao || "";
            document.getElementById("dtProduto").value = registro.dtProduto || "";
            document.getElementById("observacoes").value = registro.observacoes || "";
         };
         
         // ======= Inicializa carregando a lista do Firestore =======
         window.addEventListener("DOMContentLoaded", atualizarLista);
      </script>
   </body>
</html>