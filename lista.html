<!DOCTYPE html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <!-- Define a codifica√ß√£o de caracteres para UTF-8 -->
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- For√ßa compatibilidade com vers√µes antigas do IE -->
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <!-- Responsividade: ajusta para telas menores -->
      <meta name="description" content="Pagina Relatorio Mercado Externo">
      <!-- Descri√ß√£o da p√°gina (SEO) -->
      <meta name="author" content="Julio Cesar">
      <!-- Autor da p√°gina -->
      <title>Lista de Invoices</title>
      <!-- Biblioteca para exportar planilhas Excel -->
      <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
      <style>
         /* Reset b√°sico de margin/padding e c√°lculo de largura com bordas */
         * { margin:0; padding:0; box-sizing:border-box; }
         body {
         font-family: Arial, sans-serif; /* Fonte padr√£o */
         background: url("exportacao.png") no-repeat center center/cover; /* Fundo com imagem centralizada e cobrindo a tela */
         padding: 10px; /* Espa√ßo interno */
         min-height: 90vh; /* Altura m√≠nima: 90% da tela */
         line-height: 1.2; /* Espa√ßamento entre linhas */
         color: #333; /* Cor do texto */
         }
         h1 {
         text-align: center; /* Centraliza texto */
         margin-bottom: 10px; /* Espa√ßo abaixo */
         font-size: 1.2rem; /* Tamanho da fonte */
         color: #fff; /* Cor branca */
         text-shadow: 1px 1px 3px #000; /* Sombra no texto */
         position: sticky; /* Fixa o t√≠tulo no topo ao rolar */
         top: 0; /* Dist√¢ncia at√© o topo */
         background: rgba(0,0,0,0.3); /* Fundo semi-transparente */
         z-index:5; /* Prioridade na sobreposi√ß√£o */
         padding:6px 0; /* Espa√ßamento interno */
         border-radius:6px; /* Bordas arredondadas */
         }
         .filtro-container {
         display:flex; /* Exibe em linha */
         flex-wrap:wrap; /* Quebra para outra linha se n√£o couber */
         justify-content:flex-start; /* Alinha itens √† esquerda */
         gap:6px; /* Espa√ßo entre os elementos */
         margin-bottom:10px; /* Espa√ßo abaixo */
         align-items:center; /* Centraliza verticalmente */
         }
         .filtro-container input {
         padding:4px 6px; /* Espa√ßamento interno */
         font-size:10px; /* Fonte pequena */
         border:1px solid #ccc; /* Borda cinza clara */
         border-radius:5px; /* Bordas arredondadas */
         width:160px; /* Largura fixa */
         }
         /* Bot√µes padr√µes */
         .btn-voltar,
         .btn-limpar,
         .btn-excel {
         display:inline-block; /* Fica em linha */
         margin:0; /* Remove margem */
         background:#007bff; /* Azul padr√£o */
         color:white; /* Texto branco */
         padding:3px 6px; /* Espa√ßamento interno */
         border:none; /* Sem borda */
         border-radius:5px; /* Bordas arredondadas */
         cursor:pointer; /* Cursor de m√£ozinha */
         font-size:10px; /* Fonte pequena */
         transition:background 0.3s ease; /* Suaviza troca de cor */
         white-space:nowrap; /* Impede quebra de linha no texto */
         }
         /* Cor ao passar o mouse */
         .btn-voltar:hover,
         .btn-limpar:hover,
         .btn-excel:hover { background:#0056b3; }
         .table-container {
         width:100%; /* Ocupa toda largura */
         max-height:85vh; /* Altura m√°xima */
         overflow-x:auto; /* Scroll horizontal */
         overflow-y:auto; /* Scroll vertical */
         background:rgba(255,255,255,0.95); /* Fundo branco transl√∫cido */
         border-radius:6px; /* Bordas arredondadas */
         box-shadow:0px 2px 4px rgba(0,0,0,0.2); /* Sombra leve */
         }
         table {
         width:max-content; /* Largura m√≠nima baseada no conte√∫do */
         border-collapse:collapse; /* Remove espa√ßamento entre bordas */
         table-layout:fixed; /* Colunas fixas */
         min-width:100%; /* Largura m√≠nima = container */
         font-size:11px; /* Fonte pequena */
         }
         th, td {
         border:1px solid #ccc; /* Bordas cinza */
         padding:3px 4px; /* Espa√ßo interno */
         text-align:center; /* Texto centralizado */
         font-weight:normal; /* Peso da fonte normal */
         }
         th {
         background:#007bff; /* Azul */
         color:white; /* Texto branco */
         position:sticky; /* Cabe√ßalho fixo no topo */
         top:0; /* Gruda no topo */
         z-index:3; /* Acima das linhas */
         font-weight:bold; /* Negrito */
         font-size:11px; /* Fonte pequena */
         }
         /* Altern√¢ncia de cores entre linhas pares e √≠mpares */
         tr:nth-child(even) td { background:rgba(240,240,240,0.85); }
         tr:nth-child(odd) td { background:rgba(255,255,255,0.55); }
         /* Destaque ao passar o mouse */
         tr:hover td { background:#fdf59f !important; cursor:pointer; }
         /* C√©lulas edit√°veis com fundo diferenciado */
         td[contenteditable="true"] { background:#fff8dc; outline:none; }
         /* Linha selecionada */
         tr.ativo td { background:orange !important; font-weight:bold; color:#fff; }
         /* Campos de data */
         input[type="date"] { font-size:10px; padding:3px; border:1px solid #ccc; border-radius:4px; width:120px; }
         /* Ajuste de largura de colunas espec√≠ficas */
         th:nth-child(12), td:nth-child(12) { min-width:100px; }
         th:nth-child(13), td:nth-child(13) { min-width:130px; }
         th:nth-child(14), td:nth-child(14) {
         min-width:180px; /* largura m√≠nima */
         max-width:350px; /* largura m√°xima */
         padding:3px 5px; /* espa√ßamento */
         text-align:left; /* alinha √† esquerda */
         white-space:nowrap; /* impede quebra de linha */
         overflow:hidden; /* oculta excesso de texto */
         }
         /* Responsividade para telas m√©dias */
         @media (max-width:1024px) {
         h1 { font-size:1.1rem; } /* reduz t√≠tulo */
         table, th, td { font-size:10px; padding:2px 3px; } /* fonte menor */
         .btn-voltar, .btn-limpar, .btn-excel { font-size:9px; padding:2px 5px; } /* bot√µes menores */
         }
         /* Responsividade para tablets */
         @media (max-width:768px) {
         .filtro-container input { width:100%; } /* inputs ocupam largura total */
         table { min-width:750px; } /* largura m√≠nima da tabela */
         }
         /* Responsividade para celulares */
         @media (max-width:480px) {
         h1 { font-size:1rem; } /* t√≠tulo menor */
         th, td { font-size:9px; padding:2px 2px; } /* fonte e espa√ßamento menores */
         .filtro-container { flex-direction:column; align-items:stretch; } /* filtros em coluna */
         .btn-voltar, .btn-limpar, .btn-excel, .filtro-container input { width:100%; } /* ocupam toda largura */
         }
      </style>
   </head>
   <body>
      <h1>Lista de Invoices Faturadas</h1>
      <!-- √Årea dos filtros -->
      <div class="filtro-container">
         <button class="btn-voltar" onclick="window.location.href='index.html'">‚¨Ö Voltar</button>         
         <input type="text" id="filtroInvoice" placeholder="Pesquisar por Invoice" />
         <input type="text" id="filtroPO" placeholder="Pesquisar por PO#" />
         <input type="text" id="filtroFaturamento" placeholder="Pesquisar por DT Faturamento" />
         <input type="text" id="filtroCarregamento" placeholder="Pesquisar por DT Carregamento" />
         <input type="text" id="filtroEmbarque" placeholder="Pesquisar por DT Embarque" />
         <button class="btn-limpar" id="btnLimpar">‚úñ Limpar</button>
         <button class="btn-excel" id="btnExcel">üìÑ Exportar Excel</button>
         <button class="btn-voltar" onclick="window.location.href='valor.html'">Consultar Valor ‚û°</button>
      </div>

      <!-- √Årea da tabela -->
      <div class="table-container">
         <table id="tabela">
            <thead>
               <tr>
                  <th>Invoice</th>
                  <th>PO#</th>
                  <th>DT Faturamento</th>
                  <th>DT Carregamento</th>
                  <th>Dead-Line Draft</th>
                  <!--<th>Dead-line VGM</th>-->
                  <th>Dead-line Carga</th>
                  <th>DT Embarque</th>
                  <th>Status Faturamento</th>
                  <th>Status Booking</th>
                  <th>Instru√ß√£o de Embarque</th>
                  <th>Status Produ√ß√£o</th>
                  <th>Protid√£o do Pedido</th>
                  <th>Observa√ß√µes</th>
               </tr>
            </thead>
            <tbody id="dadosTabela"></tbody>
         </table>
      </div>
      <!-- Script principal: conecta ao Firebase e monta tabela -->
      <script type="module">
         import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
         import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
         
         // === Firebase config ===
         const firebaseConfig = {
             apiKey: "AIzaSyACGNNnZcHU1yA3Vozek5cD6egRnADDKUI",
             authDomain: "controle-mercado-externo-9c3e8.firebaseapp.com",
             projectId: "controle-mercado-externo-9c3e8",
             storageBucket: "controle-mercado-externo-9c3e8.appspot.com",
             messagingSenderId: "523084089883",
             appId: "1:523084089883:web:6b9750c6df679852b346be",
             measurementId: "G-RCJG4ZWJ9E"
         };
         
         const app = initializeApp(firebaseConfig);
         const db = getFirestore(app);
         
         const registros = [];
         const tabela = document.getElementById("dadosTabela");
         
         // === Fun√ß√£o que exibe os dados ===
         function exibirDados(dados) {
            tabela.innerHTML = "";
            if(dados.length === 0){
               const linha = document.createElement("tr");
               linha.innerHTML = `<td colspan="14" style="color:gray;font-style:italic;">Nenhuma INVOICE encontrada.</td>`;
               tabela.appendChild(linha);
            } else {
               dados.forEach(r => {
                  const linha = document.createElement("tr");
                  linha.innerHTML = `
                     <td>${r.invoice||""}</td>
                     <td>${r.po||""}</td>
                     <td>${r.dtFaturamento||""}</td>
                     <td>${r.dtCarregamento||""}</td>
                     <td>${r.draft||""}</td>
                     <td>${r.carga||""}</td>
                     <td>${r.embarque||""}</td>
                     <td>${r.status||""}</td>
                     <td>${r.booking||""}</td>
                     <td>${r.instrucao||""}</td>
                     <td>${r.producao||""}</td>
                     <td>${r.dtProduto||""}</td>
                     <td contenteditable="true">${r.observacoes||""}</td>
                  `;
                  tabela.appendChild(linha);
               });
            }
         }
         
         // === Carregar s√≥ conclu√≠das e ordenar pelo embarque ===
         async function carregarDadosFirestore(){
            const q = query(
               collection(db,"invoices"), 
               where("status", "==", "Conclu√≠do")
            );
            const querySnapshot = await getDocs(q);
         
            querySnapshot.forEach(doc => registros.push(doc.data()));
         
            // üîπ Ordenar pelo campo embarque (assumindo formato dd/mm/yyyy em texto)
            registros.sort((a,b) => {
               const dataA = a.embarque ? a.embarque.split("/").reverse().join("-") : "";
               const dataB = b.embarque ? b.embarque.split("/").reverse().join("-") : "";
               return new Date(dataA) - new Date(dataB);
            });
         
            exibirDados(registros);
         }
         carregarDadosFirestore();
         
         // === Mantive todos os filtros originais ===
         const filtroInvoice = document.getElementById("filtroInvoice");
         const filtroPO = document.getElementById("filtroPO");
         const filtroFaturamento = document.getElementById("filtroFaturamento");
         const filtroCarregamento = document.getElementById("filtroCarregamento");
         const filtroEmbarque = document.getElementById("filtroEmbarque");
         const btnLimpar = document.getElementById("btnLimpar");
         const btnExcel = document.getElementById("btnExcel");
         
         function filtrar(){
            const invoiceFiltro = filtroInvoice.value.toLowerCase();
            const poFiltro = filtroPO.value.toLowerCase();
            const faturamentoFiltro = filtroFaturamento.value.toLowerCase();
            const carregamentoFiltro = filtroCarregamento.value.toLowerCase();
            const embarqueFiltro = filtroEmbarque.value.toLowerCase();
            const dadosFiltrados = registros.filter(r =>
               (r.invoice||"").toLowerCase().includes(invoiceFiltro) &&
               (r.po||"").toLowerCase().includes(poFiltro) &&
               (r.dtFaturamento||"").toLowerCase().includes(faturamentoFiltro) &&
               (r.dtCarregamento||"").toLowerCase().includes(carregamentoFiltro) &&
               (r.embarque||"").toLowerCase().includes(embarqueFiltro)
            );
            exibirDados(dadosFiltrados);
         }
         [filtroInvoice,filtroPO,filtroFaturamento,filtroCarregamento,filtroEmbarque].forEach(f => f.addEventListener("input", filtrar));
         
         btnLimpar.addEventListener("click",()=>{
            filtroInvoice.value="";
            filtroPO.value="";
            filtroFaturamento.value="";
            filtroCarregamento.value="";
            filtroEmbarque.value="";
            filtrar();
            filtroInvoice.focus();
         });
         
         // Exportar Excel continua igual
         btnExcel.addEventListener("click", ()=>{
            const tabelaFiltrada = document.getElementById("tabela");
            const wb = XLSX.utils.book_new();
            const ws_data = [];
         
            const cabecalho = [];
            tabelaFiltrada.querySelectorAll("thead th").forEach(th => cabecalho.push(th.innerText.toUpperCase())); 
            ws_data.push(cabecalho);
         
            tabelaFiltrada.querySelectorAll("tbody tr").forEach(tr => {
               if(tr.style.display === "none") return;
               const linha = [];
               tr.querySelectorAll("td").forEach(td => linha.push(td.innerText));
               ws_data.push(linha);
            });
         
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Invoices");
            XLSX.writeFile(wb,"Lista_Invoices_Filtrada.xlsx");
         });
      </script>
   </body>
</html>